<!DOCTYPE html>
<html>
	<head>
		<link href="../css/sidenav.css" rel="stylesheet">
		<title>template OBJ</title>
		<meta charset="utf-8">
		<style>
			body {
				background:black;
				padding:0;
				margin:0;
				font-weight: bold;
				overflow:hidden;
			}

			#info {
				position: absolute;
				top: 0px;
				width: 100%;
				color: #ffffff;
				text-align:center;
			}
		</style>
		<meta charset="utf-8">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js"</script>
		<script src="http://code.jquery.com/jquery-latest.min.js"></script>
		<script src="./js/lib/three.min.js"></script>
		<script src="./js/lib/OrbitControls.js"></script>
		<script src="./js/lib/dat.gui.min.js"></script>
		<script src="./js/lib/Raycaster.js"></script>
	</head>
<body>
	<div id="mySidenav" class="sidenav">
      <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>

      <button class="accordion">AjoutObjectGeometry</button>
        <div class="panel" style="background-color: #000000;">
           <pre>
              <code class="js">
function AjoutObjectGeometry(valEnvoi){
		geometry = TrouverGeometrieCorres(valEnvoi);
		if(valEnvoi=='PointGeometry'){
			geometry.vertices.push(new THREE.Vector3( 0, 0, 0));
			var material = new THREE.PointsMaterial({color : 0xffff00,size: 100});
			mesh = new THREE.Points( geometry, material );
			sac3DObject.add( mesh );
		}else{
			var material = new THREE.MeshBasicMaterial({color : 0xffff00, wireframe: false});
			mesh=new THREE.Mesh(geometry, material);
			sac3DObject.add(mesh);
		}
		console.log(sac3DObject.children.length);
	}
              </code>
           </pre>
         </div>
		 
	   <button class="accordion">TrouverGeometrieCorres</button>
        <div class="panel" style="background-color: #000000;">
           <pre>
              <code class="js">
    Trouve le THREEGeometry correspondant à la demande
    function TrouverGeometrieCorres(vEnvoi){
		var tabGeometries = [
		{ type: 'BoxGeometry', geometry: new THREE.BoxGeometry( 200, 200, 200, 2, 2, 2 )},
		{ type: 'SphereGeometry', geometry: new THREE.SphereGeometry( 100, 12, 12 ) },
		{ type: 'PlaneGeometry', geometry: new THREE.PlaneGeometry( 200, 200, 200 ) },
		{ type: 'PointGeometry', geometry: new THREE.Geometry()}
		];
		var vgeometry = tabGeometries[0].geometry;
		for(var i=0; i&lt;tabGeometries.length;i++){
			if(tabGeometries[i].type==vEnvoi){
				vgeometry=tabGeometries[i].geometry;
			}
		}
		return vgeometry;
	}
              </code>
           </pre>
         </div>
		 
	   <button class="accordion">setPosition</button>
        <div class="panel" style="background-color: #000000;">
           <pre>
              <code class="js">
function setPosition(id1,valx,valy,valz){
		//console.log(id);
		var object = sac3DObject.getObjectById(sac3DObject.children[id1].id);
		console.log(object);
		object.position.set( valx, valy,valz );
	}
              </code>
           </pre>
         </div>
		 
		<button class="accordion">setScale</button>
        <div class="panel" style="background-color: #000000;">
           <pre>
              <code class="js">
function setScale(id2,val){
		var object = sac3DObject.getObjectById(sac3DObject.children[id2].id);
		object.scale.set( val, val, val );
	}
              </code>
           </pre>
         </div>
		 
		<button class="accordion">setColor</button>
        <div class="panel" style="background-color: #000000;">
           <pre>
              <code class="js">
function setColor(id3,val){
		var object = sac3DObject.getObjectById(sac3DObject.children[id3].id);
		object.material.color.setHex( val.replace("#","0x") );
	}
              </code>
           </pre>
         </div>
		 
		<button class="accordion">deleteElement</button>
        <div class="panel" style="background-color: #000000;">
           <pre>
              <code class="js">
function deleteElement(id3){
		var object = sac3DObject.getObjectById(sac3DObject.children[id3].id);
		object.geometry.dispose();
		sac3DObject.remove(object);
		console.log(sac3DObject.children.length);
		if((id3==0)&&(sac3DObject.children.length!==0)){menuUpdate(id3);}else if(id3>0){menuUpdate(id3-1);}else{menuP.close();}
		
	}
              </code>
           </pre>
         </div>
		 
		 <button class="accordion">Menu</button>
        <div class="panel" style="background-color: #000000;">
           <pre>
              <code class="js">
function retablirMenu(valSc,valx,valy,valz){
		options.scale = valSc;
		options.x = valx;
		options.y = valy;
		options.z = valz;
	}

	function resetMenu(idObjectSelection){
		options.id = idObjectSelection;
		options.scale = 1;
		options.x = 0;
		options.y = 0;
		options.z = 0;
		options.color = "#ff0000";
	}

	function resetElement(idObjectSelection){
		options.scale = 1;
		options.x = 0;
		options.y = 0;
		options.z = 0;
		options.color = "#ff0000";
		setScale(idObjectSelection,options.scale)
		setPosition(idObjectSelection,options.x,options.y,options.z)
		setColor(idObjectSelection,options.color);
	}        
	
			</code>
           </pre>
         </div>
		 
		 <button class="accordion">MQTT message(lib Paho)</button>
        <div class="panel" style="background-color: #000000;">
           <pre>
              <code class="js">
client.onMessageArrived = function (message) {
						console.log("Message arrive: " + message.payloadString);
						console.log("Topic:     " + message.destinationName);
						var msg=message.payloadString;
					


						var tab=msg.split(" ");

						if(tab[0]=="cr"){
							var vgeo = tab[1];
							AjoutObjectGeometry(vgeo);
							cpt = cpt + 1;
						}else if(tab[0]=="pos"){
							var vdonnee = tab[1].split(" ");
							var vid = vdonnee[0];
							console.log(vdonnee[0]);
							var vpos = tab[2].split(".");
							var vx = vpos[0];
							var vy = vpos[1];
							var vz = vpos[2];
							setPosition(vid,vx,vy,vz);
						}else if(tab[0]== "select" ){
							var vid = tab[1];
							selectObject(vid,lastSelect);

						}else if(tab[0]=="delete"){
							var vid = tab[1];
							deleteElement(vid);
						}else if(tab[0]=="scl"){
							var vid = tab[1];
							var vscale = tab[2];
							setScale(vid,vscale);
						}else if(tab[0]=="col"){
							var id = tab[1];
							var color = tab[2];
							setColor(id,color);
						}
			}  
	
			</code>
           </pre>
         </div>
		 
      <a href="../index.nginx-debian.html">Accueil</a>
    </div>
	<div id="main">
      <span style="font-size:30px;cursor:pointer" onclick="openNav()">&#9776; open</span>
    </div>

    <script>
    function openNav() {
        document.getElementById("mySidenav").style.width = "50%";
        document.getElementById("main").style.marginRight = "50%";
    }

    function closeNav() {
        document.getElementById("mySidenav").style.width = "0";
        document.getElementById("main").style.marginRight= "0";
    }
    </script>
    <script>
      var acc = document.getElementsByClassName("accordion");
      var i;

      for (i = 0; i < acc.length; i++) {
        acc[i].addEventListener("click", function() {
          this.classList.toggle("active");
          var panel = this.nextElementSibling;
          if (panel.style.display){
            panel.style.display = null;
          } else {
            panel.style.display = "block";
          } 
        });
      }
    </script>
	<!--///////////////////////////////////////////////////////FIN SIDENAV///////////////////////////////////////////////////-->
	
	<div id="container" style="width: 640px; height: 480px; background-color: #000000;"></div>
	
	<script type="text/javascript">
	var renderer, scene, camera, mesh;
	var sac3DObject; // contient tous les objects 3d de la scene
	var lastSelect;
	var options;
	var SELECTED;
	var idObjectSelection=0;
	var raycaster = new THREE.Raycaster();
	var mouse = new THREE.Vector2();


	init();
	animate();
	function init(){
		//rendere
		renderer=new THREE.WebGLRenderer();//moteur de rendu
		renderer.setSize(window.innerWidth, window.innerHeight);
		document.getElementById('container').appendChild(renderer.domElement);
		//scene
		scene= new THREE.Scene();//scene
		scene.background=new THREE.Color(0x000000);
		//camera
		camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight,1,10000);
		camera.position.set(0,0,1000);
		scene.add(camera);

		//creation du sac
		sac3DObject= new THREE.Group();
		scene.add(sac3DObject);

		//Creation d'un objet à ajouter dans le sac


		////////////////
		//menu de base//
		////////////////
		
		gui = new dat.GUI({width: 350});
		menuP=gui.addFolder('Parametre de l element');
		options={ 
					element: 0,
					ids: idObjectSelection,
					scale: 0.1,
					x: 0, y: 0, z:0,
					color: "#ff0000",
					reset : function(){},
					detruire: function(){}
			};
		

		
		
		//action de la souris
		window.addEventListener( 'mousedown', onMouseDown, false );
		//premier rendu
		render();


	}


	function render(){
		
		renderer.render(scene, camera);

	}



	function animate(){
		requestAnimationFrame(animate);//fonction recuresive a chaque frame
		if ( mesh == undefined ) {//si aucun mesh alors on fait rien
			render();
		}else{
			var i=0;
			var nbChildren = sac3DObject.children.length;
			for(i=0;i<nbChildren;i++){
				sac3DObject.children[i].rotation.x += 0.01; //tourne le dernier mesh crée
				sac3DObject.children[i].rotation.y += 0.02;
			}
			render();
		}
	}


	function AjoutObjectGeometry(valEnvoi){
		geometry = TrouverGeometrieCorres(valEnvoi);
		if(valEnvoi=='PointGeometry'){
			geometry.vertices.push(new THREE.Vector3( 0, 0, 0));
			var material = new THREE.PointsMaterial({color : 0xffff00,size: 100});
			mesh = new THREE.Points( geometry, material );
			sac3DObject.add( mesh );
		}else{
			var material = new THREE.MeshBasicMaterial({color : 0xffff00, wireframe: false});
			mesh=new THREE.Mesh(geometry, material);
			sac3DObject.add(mesh);
		}
		console.log(sac3DObject.children.length);
	}


	//Trouve le THREEGeometry correspondant à la demande
	function TrouverGeometrieCorres(vEnvoi){
		var tabGeometries = [
		{ type: 'BoxGeometry', geometry: new THREE.BoxGeometry( 200, 200, 200, 2, 2, 2 )},
		{ type: 'SphereGeometry', geometry: new THREE.SphereGeometry( 100, 12, 12 ) },
		{ type: 'PlaneGeometry', geometry: new THREE.PlaneGeometry( 200, 200, 200 ) },
		{ type: 'PointGeometry', geometry: new THREE.Geometry()}
		];
		var vgeometry = tabGeometries[0].geometry;
		for(var i=0; i<tabGeometries.length;i++){
			if(tabGeometries[i].type==vEnvoi){
				vgeometry=tabGeometries[i].geometry;
			}
		}
		return vgeometry;
	}

	function setPosition(id1,valx,valy,valz){
		//console.log(id);
		var object = sac3DObject.getObjectById(sac3DObject.children[id1].id);
		console.log(object);
		object.position.set( valx, valy,valz );
	}

	function setScale(id2,val){
		var object = sac3DObject.getObjectById(sac3DObject.children[id2].id);
		object.scale.set( val, val, val );
	}

	function setColor(id3,val){
		var object = sac3DObject.getObjectById(sac3DObject.children[id3].id);
		object.material.color.setHex( val.replace("#","0x") );
	}

	function deleteElement(id3){
		var object = sac3DObject.getObjectById(sac3DObject.children[id3].id);
		object.geometry.dispose();
		sac3DObject.remove(object);
		console.log(sac3DObject.children.length);
		if((id3==0)&&(sac3DObject.children.length!==0)){menuUpdate(id3);}else if(id3>0){menuUpdate(id3-1);}else{menuP.close();}
		
	}

	function retablirMenu(valSc,valx,valy,valz){
		options.scale = valSc;
		options.x = valx;
		options.y = valy;
		options.z = valz;
	}

	function resetMenu(idObjectSelection){
		options.id = idObjectSelection;
		options.scale = 1;
		options.x = 0;
		options.y = 0;
		options.z = 0;
		options.color = "#ff0000";
	}

	function resetElement(idObjectSelection){
		options.scale = 1;
		options.x = 0;
		options.y = 0;
		options.z = 0;
		options.color = "#ff0000";
		setScale(idObjectSelection,options.scale)
		setPosition(idObjectSelection,options.x,options.y,options.z)
		setColor(idObjectSelection,options.color);
	}

	function selectObject(id){
			var object = sac3DObject.getObjectById(sac3DObject.children[id].id);
			
			if(SELECTED !== object){
				if(SELECTED) SELECTED.material.color.set(0xff0000);
					SELECTED = object;
					idObjectSelection = id;
					options.ids=idObjectSelection;
					SELECTED.material.color.set(0xffffff);
			}
			
			menuOnSelectGeometry(idObjectSelection);
	}

//Ouvre un menu base sur l'objet selectionné
var sc, x, y, z, detruire,col,rst,idm;
	function menuOnSelectGeometry(idObjectSelection){	

		if(menuP.__controllers.length==0){
			idm=menuP.add( options, 'ids').listen().onChange( function( value ) { options.ids=idObjectSelection} );
			sc =menuP.add( options, 'scale').min(0.1).max(4).listen().onChange( function( value ) { 	console.log(idObjectSelection);setScale(idObjectSelection,options.scale); } );
			x= menuP.add( options, 'x').min(-900).max(900).listen().onChange( function( value ) { setPosition(idObjectSelection,options.x,options.y,options.z); } );
			y=menuP.add( options, 'y').min(-900).max(900).listen().onChange( function( value ) { setPosition(idObjectSelection,options.x,options.y,options.z); } );
			z=menuP.add( options, 'z').min(-900).max(900).listen().onChange( function( value ) { setPosition(idObjectSelection,options.x,options.y,options.z); } );
			col = menuP.addColor( options, 'color').name('color').listen().onChange( function( value ) { setColor(idObjectSelection,options.color); } );
			rst = menuP.add(options,'reset').name("Reset Element").listen().onChange( function( value ) { resetElement(idObjectSelection); });
			detruire=menuP.add(options,'detruire').name("detruire").listen().onChange( function( value ) { deleteElement(idObjectSelection); } );
			menuP.open();
		}else{
			menuUpdate(idObjectSelection);
		}
	}

	function menuUpdate(idObjectSelection){
		var object = sac3DObject.getObjectById(sac3DObject.children[idObjectSelection].id);
		idm.onChange( function( value ) { options.ids=idObjectSelection} );
		sc.onChange( function( value ) { 	console.log(idObjectSelection);setScale(idObjectSelection,options.scale); } );
		x.onChange( function( value ) { setPosition(idObjectSelection,options.x,options.y,options.z); } );
		y.onChange( function( value ) { setPosition(idObjectSelection,options.x,options.y,options.z); } );
		z.onChange( function( value ) { setPosition(idObjectSelection,options.x,options.y,options.z); } );
		col.onChange( function( value ) { setPosition(idObjectSelection,options.x,options.y,options.z); } );
		detruire.onChange( function( value ) { deleteElement(idObjectSelection); } );
		if((object.position.x !== 0) || (object.position.y !== 0) || (object.position.z !== 0) || (object.scale.x !== 1)){
				retablirMenu(object.scale.x,object.position.x,object.position.y,object.position.z,object.material.color);
				menuP.open();
		}else{
				resetMenu(idObjectSelection);
				menuP.open();
		}

	}

	function onMouseDown( event ){
		mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
		mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
		raycaster.setFromCamera(mouse, camera)//position du raycaster avec la camera et la position de la souris
		var intersects = raycaster.intersectObjects( sac3DObject.children );
		if( intersects.length>0){
			var intersect = intersects[ 0 ];
            var id = intersect.object.id;
            var idSac=0;
            for(var i=0;i<sac3DObject.children.length;i++){
                if(sac3DObject.children[i].id==id){
                    idSac=i;
                }
            }
		}
		
	}

	////////////////////////////////////////
	//MQTT/////////////////////////////////
/////////////////////////////////////////////////////
	//Creation objet : commande => cr [BoxGeometry|SphereGeometry|PlaneGeometry|PointGeometry]
	//Entrer position : commande => pos id x.y.z
	//Entrer l'echele : commande => scl id scale
	//Changer couleur : commande => col id hexa
	//Selectionner un objet : commande => select id
	//Ouvrir menu avec l'id et tout parametre  
	//detruire un objet : commande => delete id
		client = new Paho.MQTT.Client("91.224.148.106", Number(2533),"templateGeo");

			var cpt = 0;
			client.onConnectionLost = function (responseObject){
				console.log("Connection perdue: "+responseObject.errorMessage);
			}




			function onConnect(){
				console.log("Connecte");
				client.subscribe("templateGeo");
			}

			client.connect({onSuccess: onConnect});

			client.onMessageArrived = function (message) {
						console.log("Message arrive: " + message.payloadString);
						console.log("Topic:     " + message.destinationName);
						var msg=message.payloadString;
					


						var tab=msg.split(" ");

						if(tab[0]=="cr"){
							var vgeo = tab[1];
							AjoutObjectGeometry(vgeo);
							cpt = cpt + 1;
						}else if(tab[0]=="pos"){
							var vdonnee = tab[1].split(" ");
							var vid = vdonnee[0];
							console.log(vdonnee[0]);
							var vpos = tab[2].split(".");
							var vx = vpos[0];
							var vy = vpos[1];
							var vz = vpos[2];
							setPosition(vid,vx,vy,vz);
						}else if(tab[0]== "select" ){
							var vid = tab[1];
							selectObject(vid,lastSelect);

						}else if(tab[0]=="delete"){
							var vid = tab[1];
							deleteElement(vid);
						}else if(tab[0]=="scl"){
							var vid = tab[1];
							var vscale = tab[2];
							setScale(vid,vscale);
						}else if(tab[0]=="col"){
							var id = tab[1];
							var color = tab[2];
							setColor(id,color);
						}
			}





	</script>
</body>
</html>